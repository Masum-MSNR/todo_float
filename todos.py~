import os
import pickle
from tkinter.simpledialog import askstring
import tkinter as tk

class TodoManager:
    def __init__(self, widget):
        self.widget = widget
        self.todos = []

    def load_todos(self):
        if os.path.exists("todos.pkl"):
            try:
                with open("todos.pkl", "rb") as f:
                    if os.path.getsize("todos.pkl") > 0:
                        todos = pickle.load(f)
                        for todo in todos:
                            if 'var' not in todo:
                                todo['var'] = tk.IntVar(value=1 if todo['checked'] else 0)
                        self.todos = todos
            except (EOFError, pickle.UnpicklingError):
                self.todos = []

    def save_todos(self):
        serializable_todos = [{'task': todo['task'], 'checked': todo['checked']} for todo in self.todos]
        with open("todos.pkl", "wb") as f:
            pickle.dump(serializable_todos, f)

    def add_todo(self):
        todo_text = askstring("To-Do", "Enter your task:", parent=self.widget.root)
        if todo_text:
            todo = {'task': todo_text, 'checked': False, 'var': tk.IntVar(value=0)}
            self.todos.append(todo)
            self.save_todos()
            self.widget.ui_manager.update_todo_list()

    def toggle_rectangle(self, idx):
        todo = self.todos[idx]
        todo['checked'] = not todo['checked']
        self.widget.ui_manager.update_single_rectangle(idx)
        self.save_todos()

    def delete_todo(self, idx):
        del self.todos[idx]
        self.save_todos()
        self.widget.ui_manager.update_todo_list()

    def reset_checkboxes(self):
        for todo in self.todos:
            todo['checked'] = False
            todo['var'].set(0)
        self.save_todos()
        self.widget.ui_manager.update_todo_list()
